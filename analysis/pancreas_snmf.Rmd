---
title: Revisiting semi-NMF for the pancreas data
author: Peter Carbonetto
output: workflowr::wflow_html
---

In the
[more detailed analysis of the pancreas data](pancreas_snmf.html), the
semi-NMF results looked quite interesting and interpretable. As we
show here, increasing the number of semi-NMF factors yields additional
interesting structure

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

First, load the packages needed for this analysis.

```{r load-pkgs, message=FALSE}
library(Matrix)
library(fastTopics)
library(ggplot2)
library(cowplot)
```

Set the seed for reproducibility.

```{r set-seed}
set.seed(1)
```

## CEL-Seq2 data

Let's start with the "CEL-Seq2" data. First load the CEL-Seq2 pancreas
data and the outputs generated by running the
`fit_pancreas_celseq2_snmf.R` script.

```{r load-data-celseq2}
load("../data/pancreas.RData")
load("../output/pancreas_celseq2_snmf.RData")
i           <- which(sample_info$tech == "celseq2")
sample_info <- sample_info[i,]
counts      <- counts[i,]
sample_info <- transform(sample_info,celltype = factor(celltype))
celltype <- sample_info$celltype
celltype <-
 factor(celltype,
        c("acinar","ductal","activated_stellate","quiescent_stellate",
          "endothelial","macrophage","mast","schwann","alpha","beta",
          "delta","gamma","epsilon"))
```

### flashier

Here is the semi-NMF fit generated by flashier:

```{r structure-plots-celseq2-flashier, fig.height=4, fig.width=8, message=FALSE, results="hide"}
other_colors <- c("#66c2a5","#fc8d62","#8da0cb")
L <- fl_snmf_ldf$L
k <- ncol(L)
colnames(L) <- paste0("k",1:k)
celltype_factors  <- 2:9
other_factors <- c(1,10,11)
p1 <- structure_plot(L[,celltype_factors],grouping = celltype,
                     gap = 20,perplexity = 70,n = Inf) +
  labs(y = "membership",fill = "factor",color = "factor",
       title = "cell-type factors")
p2 <- structure_plot(L[,other_factors],grouping = celltype,
                     gap = 20,perplexity = 70,n = Inf) +
  scale_color_manual(values = other_colors) +
  scale_fill_manual(values = other_colors) +
  labs(y = "membership",fill = "factor",color = "factor",
       title = "other factors")
plot_grid(p1,p2,nrow = 2,ncol = 1)
```

As before, the semi-NMF is capturing cell types a different levels of
specificity, but with $K = 11$ factors has identified additional
factors for acinar cells and quiescent vs. activated stellate cells.

### Covariance decomposition

Another appraoch to generating a semi-NMF is to decompose the
cell-by-cell covariance matrix, which implicitly assumes that the LFCs
(the "gene signatures") are orthogonal to each other. This is
implemented by the gbcd package. (By default, gbcd also encourages the
loadings to be binary through a prior, but here we used a
point-exponential prior which does not encourage this.)

For fair comparison, this decomposition was generated with the same
number of factors.

```{r structure-plots-celseq2-gbcd, fig.height=4, fig.width=8, message=FALSE, results="hide"}
L <- fl_cd_ldf$L
k <- ncol(L)
colnames(L) <- paste0("k",1:k)
celltype_factors  <- c(2,3,5,6,4,9,11)
other_factors <- c(1,8,10)
p1 <- structure_plot(L[,celltype_factors],grouping = celltype,
                     gap = 20,perplexity = 70,n = Inf) +
  labs(y = "membership",fill = "factor",color = "factor",
       title = "cell-type factors")
p2 <- structure_plot(L[,other_factors],grouping = celltype,
                     gap = 20,perplexity = 70,n = Inf) +
  scale_color_manual(values = other_colors) +
  scale_fill_manual(values = other_colors) +
  labs(y = "membership",fill = "factor",color = "factor",
       title = "other factors")
plot_grid(p1,p2,nrow = 2,ncol = 1)
```

This covariance decomposition captures much of the same structure as
the semi-NMF above — I tried to show this by using the same colors for
the factors — but also missed some interesting structure, e.g., a
separate factor for endothelial cells, and does not distinguish well
alpha cells from delta and gamma cells.

## Smart-seq2 data

The "Smart-seq2" data is another interesting pancreas data set that is
roughly the same size as the CEL-Seq2 data set, and contains
transcriptional profiles from some of the same cell types. Let's redo
the comparisons above on this data set.

Load the Smart-Seq2 data and the outputs generated from running
the `fit_pancreas_smartseq2_snmf.R` script.

```{r load-data-smartseq2}
load("../data/pancreas.RData")
load("../output/pancreas_smartseq2_snmf.RData")
i           <- which(sample_info$tech == "smartseq2")
sample_info <- sample_info[i,]
counts      <- counts[i,]
sample_info <- transform(sample_info,celltype = factor(celltype))
celltype <- sample_info$celltype
celltype <-
 factor(celltype,
        c("acinar","ductal","activated_stellate","quiescent_stellate",
		  "endothelial","macrophage","mast","schwann","alpha",
		  "beta","delta","gamma","epsilon"))
```

### flashier

ADD TEXT HERE.

```{r structure-plots-smartseq2-flashier, fig.height=4, fig.width=8, message=FALSE, results="hide"}
L <- fl_snmf_ldf$L
k <- ncol(L)
colnames(L) <- paste0("k",1:k)
celltype_factors  <- c(3,4,6,7,9:11)
other_factors <- c(1,2,5,8)
p1 <- structure_plot(L[,celltype_factors],grouping = celltype,
                     gap = 20,perplexity = 70,n = Inf) +
  labs(y = "membership",fill = "factor",color = "factor",
       title = "cell-type factors")
p2 <- structure_plot(L[,other_factors],grouping = celltype,
                     gap = 20,perplexity = 70,n = Inf) +
  labs(y = "membership",fill = "factor",color = "factor",
       title = "other factors")
plot_grid(p1,p2,nrow = 2,ncol = 1)
```

### covariance decomposition

ADD TEXT HERE.

```{r structure-plots-smartseq2-gbcd, fig.height=4, fig.width=8, message=FALSE, results="hide"}
L <- fl_cd_ldf$L
k <- ncol(L)
colnames(L) <- paste0("k",1:k)
celltype_factors  <- c(2,4,5,8:11)
other_factors <- c(1,3,6,7)
p1 <- structure_plot(L[,celltype_factors],grouping = celltype,
                     gap = 20,perplexity = 70,n = Inf) +
  labs(y = "membership",fill = "factor",color = "factor",
       title = "cell-type factors")
p2 <- structure_plot(L[,other_factors],grouping = celltype,
                     gap = 20,perplexity = 70,n = Inf) +
  labs(y = "membership",fill = "factor",color = "factor",
       title = "other factors")
plot_grid(p1,p2,nrow = 2,ncol = 1)
```
