---
title: NMF analysis of the "pancreas cytokine" data set (untreated mouse only)
author: Peter Carbonetto
output: workflowr::wflow_html
---

ADD OVERVIEW OF THIS ANALYSIS HERE.

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load packages used to process the data, perform the analyses, and
create the plots.

```{r load-pkgs, message=FALSE}
library(Matrix)
library(fastTopics)
library(flashier)
library(singlecelljamboreeR)
library(ggplot2)
library(cowplot)
```

Set the seed for reproducibility:

```{r set-seed}
set.seed(1)
```

Load the prepared data set:

```{r load-data}
load("../data/pancreas_cytokine.RData")
```

Here we will analyze the cells from the untreated mouse only:

```{r filter-cells-1}
i       <- which(samples$mouse == "S1")
samples <- samples[i,]
counts  <- counts[i,]
```

Remove two cells that appear to be outliers:

```{r filter-cells-2}
outliers <- c("TTTGTTGTCGTTAGTG-1","TTTGTTGGTAGAGCTG-1")
i        <- which(!is.element(samples$barcode,outliers))
samples  <- samples[i,]
counts   <- counts[i,]
```

Remove genes that are expressed in fewer than 5 cells:

```{r filter-genes}
j      <- which(colSums(counts > 0) > 4)
genes  <- genes[j,]
counts <- counts[,j]
```

This is the dimension of the data set we will analyze:

```{r dim-counts}
dim(counts)
```

For the Gaussian-based analyses, we will need the shifted log counts:

```{r shifted-log-counts}
a <- 1
s <- rowSums(counts)
s <- s/mean(s)
shifted_log_counts <- log1p(counts/(a*s))
rownames(shifted_log_counts) <- NULL
```

TO DO: Remove the ribosomal protein and mitochondrial genes.
(And check that this is a good idea.)

## Topic model (fastTopics)

Fit a topic model with $K = 5$ topics to the counts:

```{r fit-topic-model}
tm <- fit_poisson_nmf(counts,k = 5,init.method = "random",method = "em",
                      numiter = 40,verbose = "detailed",
					  control = list(numiter = 4,nc = 8,extrapolate = FALSE))
tm <- fit_poisson_nmf(counts,fit0 = tm,method = "scd",numiter = 80,
                      control = list(numiter = 4,nc = 8,extrapolate = TRUE),
					  verbose = "detailed")
```

Structure plot comparing the topics to the clusters:

```{r structure-plot-topic-model, fig.height=1.5, fig.width=7, eval=FALSE}
topic_colors <- c("magenta","darkorange","darkblue","forestgreen",
                  "dodgerblue","gray","red","olivedrab","darkmagenta",
                  "sienna","limegreen","royalblue","lightskyblue",
				  "gold")
samples <- transform(samples,cluster = factor(cluster))
p <- structure_plot(tm,grouping = samples$cluster,gap = 20,
               colors = topic_colors)
print(p)
```

## EBNMF (flashier)

Next fit an NMF to the shifted log counts using flashier, with $K =
10$:

```{r flashier-nmf, eval=FALSE}
n  <- nrow(samples)
x  <- rpois(1e7,1/n)
s1 <- sd(log(x + 1))
fl_nmf <- flash(shifted_log_counts,S = s1,ebnm_fn = ebnm_point_exponential,
                var_type = 2,greedy_Kmax = 10,backfit = FALSE,
				nullcheck = FALSE,verbose = 2)
fl_nmf <- flash_backfit(fl_nmf,extrapolate = FALSE,maxiter = 40,
                        verbose = 2)
fl_nmf <- flash_backfit(fl_nmf,extrapolate = TRUE,maxiter = 80,
                        verbose = 2)
```

Structure plot comparing the factors to the clusters:

```{r structure-plot-flashier-nmf, fig.height=2, fig.width=7, eval=FALSE}
L <- ldf(fl_nmf,type = "i")$L
p <- structure_plot(L,grouping = samples$cluster,gap = 20,
                    colors = topic_colors)
print(p)
```
