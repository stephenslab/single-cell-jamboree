---
title: NMF analysis of the "pancreas cytokine" data set (untreated mouse only)
author: Peter Carbonetto
output: workflowr::wflow_html
---

Here we perform a NMF analyses of the
["pancreas cytokine" data set](pancreas_cytokine.html), focussing on
the scRNA-seq data from untreated mouse only.

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load packages used to process the data, perform the analyses, and
create the plots.

```{r load-pkgs, message=FALSE}
library(Matrix)
library(fastTopics)
library(NNLM)
library(flashier)
library(singlecelljamboreeR)
library(ggplot2)
library(cowplot)
```

Set the seed for reproducibility:

```{r set-seed}
set.seed(1)
```

Load the prepared data set:

```{r load-data}
load("../data/pancreas_cytokine.RData")
```

Here we will analyze the cells from the untreated mouse only:

```{r filter-cells-1}
i       <- which(samples$mouse == "S1")
samples <- samples[i,]
counts  <- counts[i,]
```

Remove three cells that appear to be outliers (one of them appears to
be an acinar cell based on Eric's analysis):

```{r filter-cells-2}
outliers <- c("TTTGTTGTCGTTAGTG-1","TTTGTTGGTAGAGCTG-1","CCCAACTCACTCATAG-1")
i        <- which(!is.element(samples$barcode,outliers))
samples  <- samples[i,]
counts   <- counts[i,]
```

Remove genes that are expressed in fewer than 5 cells:

```{r filter-genes}
j      <- which(colSums(counts > 0) > 4)
genes  <- genes[j,]
counts <- counts[,j]
```

This is the dimension of the data set we will analyze:

```{r dim-counts}
dim(counts)
```

For the Gaussian-based analyses (later), we will need the shifted log
counts:

```{r shifted-log-counts}
a <- 1
s <- rowSums(counts)
s <- s/mean(s)
shifted_log_counts <- log1p(counts/(a*s))
rownames(shifted_log_counts) <- NULL
```

## Topic model (fastTopics)

Fit a topic model to the counts (with $K = 13$ topics):

```{r fit-topic-model, cache=TRUE}
set.seed(1)
tm <- fit_poisson_nmf(counts,k = 13,init.method = "random",method = "em",
                      numiter = 40,verbose = "none",
					  control = list(numiter = 4,nc = 8,extrapolate = FALSE))
tm <- fit_poisson_nmf(counts,fit0 = tm,method = "scd",numiter = 40,
                      control = list(numiter = 4,nc = 8,extrapolate = TRUE),
					  verbose = "none")
```

Structure plots comparing the topics to the clusters (some of which
are inferred from the topics):

```{r structure-plot-topic-model, fig.height=4.25, fig.width=6.5, results="hide", message=FALSE}
set.seed(1)
celltype_topics <- paste0("k",c(2,3,5,7:9,13))
other_topics <- paste0("k",c(4,1,6,10:12))
L <- poisson2multinom(tm)$L
clusters <- as.character(samples$cluster)
clusters[clusters == "islet"]                  <- "beta"
clusters[clusters == "beta" & L[,"k3"] > 0.25] <- "alpha"
clusters[clusters == "beta" & L[,"k8"] > 0.25] <- "delta+epsilon"
clusters[clusters == "beta" & L[,"k9"] > 0.25] <- "gamma"
clusters <- factor(clusters,c("beta","alpha","delta+epsilon","gamma","duct",
                              "endothelial-mesenchymal","macrophage"))
i <- c(sample(which(clusters == "beta"),400),
       which(clusters != "beta"))
p1 <- structure_plot(L[i,],grouping = clusters[i],topics = celltype_topics,
                     gap = 10,n = Inf) +
  labs(fill = "")
p2 <- structure_plot(L[i,],grouping = clusters[i],topics = other_topics,
                     gap = 10,n = Inf) +
  labs(fill = "")
plot_grid(p1,p2,nrow = 2,ncol = 1)
```

Based on the estimated $\mathbf{F}$, we have the following potential
interpretation of the topics:

+ topic 2: $\beta$ cells (*Ins1*, *Ins2*, *Mafa*)
+ topic 3: $\alpha$ cells (*Gcg*, *Mafb*)
+ topic 5: duct cells (*Krt19*)
+ topic 6: replicate effect
+ topic 7: macrophages (*Ccr5*)
+ topic 8: $\delta$ cells (*Sst*)
+ topic 9: $\gamma$ cells (*Ppy*)
+ topic 12: cell cycle
+ topic 13: endothelial (*Pecam1*) and mesenchymal cells (*Col1a1*).

Topic 10 is clearly capturing a technical difference in the two
replicates:

```{r k10-vs-replicate, fig.height=2, fig.width=2}
pdat <- cbind(samples,L)
ggplot(pdat,aes(x = replicate,y = k10)) +
  geom_boxplot() +
  theme_cowplot(font_size = 12)
```

TO DO: Add annotation heatmaps as a way to summarize the topic
modeling results.

```{r annotation-heatmap-topic-model, eval=FALSE}
scale_rows <- function (A)
  A / apply(A,1,max)
marker_genes <- c("Ins1","Ins2","Mafa","Gcg","Mafb","Sst","Ghrl",
                  "Ppy","Chga","Iapp","Krt19","Ccr5","Pecam1","Esam",
				  "Col1a1","Ghrl")
j <- match(marker_genes,genes$symbol)
F <- poisson2multinom(tm)$F
F <- F[j,]
F <- scale_rows(F)
rownames(F) <- marker_genes
topics <- paste0("k",c(5,4,6,7,2,3))
annotation_heatmap(F[,topics],select_features = "all",verbose = FALSE)
```

## EBNMF (flashier)

Next we will fit an NMF to the *shifted log counts* using flashier,
with $K = 13$. Since the greedy initialization does not seem to work
well in this example, I'll use a different initialization strategy:
obtain a "good" initialization using the NNLM package, then use this
initialization to fit a NMF using flashier. This approach is
implemented in the following function:

```{r flashier-nmf-function}
flashier_nmf <- function (X, k = 3, n.threads = 1) {
  n <- nrow(X)
  m <- ncol(X)
  Y <- as.matrix(X)
  nmf0 <- nnmf(Y,k = 1,loss = "mse",method = "scd",max.iter = 10,
               verbose = 2,n.threads = n.threads)
  W0 <- nmf0$W
  H0 <- nmf0$H
  W0 <- cbind(W0,matrix(runif(n*(k-1)),n,k-1))
  H0 <- rbind(H0,matrix(runif(m*(k-1)),k-1,m))
  nmf <- nnmf(Y,k,init = list(W = W0,H = H0),loss = "mse",method = "scd",
              max.iter = 10,verbose = 2,n.threads = n.threads)
  x  <- rpois(1e7,1/n)
  s1 <- sd(log(x + 1))
  out <- flash_init(X,var_type = 2,S = s1)
  out <- flash_factors_init(out,list(nmf$W,t(nmf$H)),ebnm_point_exponential)
  out <- flash_backfit(out,extrapolate = FALSE,maxiter = 100,verbose = 2)
  return(flash_backfit(out,extrapolate = TRUE,maxiter = 100,verbose = 2))
}
```

Now fit an NMF to the shifted log counts, with $K = 13$:

```{r flashier-nmf, cache=TRUE, warning=FALSE, cache=TRUE}
set.seed(1)
fl_nmf <- flashier_nmf(shifted_log_counts,k = 13,n.threads = 8)
```

Structure plot comparing the factors to the clusters:

```{r structure-plot-flashier-nmf, fig.height=4, fig.width=6.5, results="hide", message=FALSE}
set.seed(1)
celltype_factors <- paste0("k",c(1:5,9:11,13))
other_factors <- paste0("k",c(6:8,12))
L <- ldf(fl_nmf,type = "i")$L
colnames(L) <- paste0("k",1:13)
i <- c(sample(which(clusters == "beta"),400),
       which(clusters != "beta"))
p1 <- structure_plot(L[i,],grouping = clusters[i],topics = celltype_factors,
                    gap = 10,n = Inf) +
  labs(y = "membership",fill = "")
p2 <- structure_plot(L[i,],grouping = clusters[i],topics = other_factors,
                    gap = 10,n = Inf) +
  labs(y = "membership",fill = "")
print(plot_grid(p1,p2,nrow = 2,ncol = 1))
```

Based on the estimated $\mathbf{F}$, we have the following potential
interpretation of the topics:

+ factor 1: $\beta$ cells (*Ins1*, *Ins2*, *Mafa*)
+ factors 2, 9, 11: endothelial cells (*Pecam1*, *Esam*)
+ factor 3: duct cells (*Krt19*)
+ factor 4: macrophages (*Ccr5*)
+ factor 5: $\alpha$ (*Gcg*, *Mafb*) and $\gamma$ cells (*Ppy*)
+ factor 6: replicate effect
+ factors 7, 12: cell cycle
+ factor 10: mesenchymal cells (*Col1a1*)
+ factor 13: $\delta$ cells (*Sst*)

TO DO: It seems that there are some other interesting "cluster-like"
factors within the endothelial-mesenchymal that need to be studied in
more detail to determine what they are. Actually those clusters 

Factor 6 almost perfectly captures the technical difference in the two
replicates:

```{r k6-vs-replicate, fig.height=2, fig.width=2}
pdat <- cbind(samples,L)
r <- cor(as.numeric(samples$replicate),L[,"k6"])
ggplot(pdat,aes(x = replicate,y = k6)) +
  geom_boxplot() +
  ggtitle(paste("cor =",round(r,digits = 3))) +
  theme_cowplot(font_size = 12)
```

Factors 7 and 12 appears to be capturing cell cycle (TO DO: UPDATE THIS):

```{r cell-cycle}
cell_cycle <-
c("Ccnb1", "Ccnd1", "Ccnd2", "Ccnd3", "Ccne1", "Ccnh", "Cdc25a",
"Cdk1", "Cdk2", "Cdk4", "Cdk6", "Cdk7", "Cdkn1a", "Cdkn1b", "Cdkn2a",
"Cdkn2b", "Cdkn2c", "Cdkn2d", "E2f1", "Rb1", "Rbl1", "Tfdp1")
F <- ldf(fl_nmf,type = "i")$F
rownames(F) <- genes$symbol
colnames(F) <- paste0("k",1:13)
sort(colSums(F[cell_cycle,]))
```

TO DO: Add annotation heatmaps as a way to summarize the results of
the EBNMF analysis.

```{r annotation-heatmap-flashier-nmf, eval=FALSE}
scale_cols <- function (A) {
  b <- apply(A,2,max)
  return(t(t(A) * b))
}
marker_genes <- c("Ins1","Ins2","Mafa","Gcg","Mafb","Sst","Ghrl",
                  "Ppy","Chga","Iapp","Krt19",
                  "Ccr5","Pecam1","Esam","Col1a1")
j <- match(marker_genes,genes$symbol)
F <- ldf(fl_nmf,type = "i")$F
F <- scale_cols(F)
F <- F[j,]
rownames(F) <- marker_genes
colnames(F) <- paste0("k",1:7)
factors <- paste0("k",c(4,7,3,5,2,6))
annotation_heatmap(F[,factors],select_eatures = "all",verbose = FALSE)
```

TO DO:

+ Run de_analysis with lfc.stat = "vsnull" to "shrink" the topics.

+ Compare topics and corresponding factors in scatterplots.
  See temp2.R.
  
+ Identify "distinctive" genes using de_analysis for topic model
  and with a custom function from the singlecelljamboree package
  for the factors.

+ Create annotation plots for the topic model and the EBNMF model.

+ The cell cycle factors (k7, k12) are other examples where the factors
  are largely independent from the others.
