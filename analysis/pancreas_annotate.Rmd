---
title: Annotation of pancreas factors
author: Peter Carbonetto
output: workflowr::wflow_html
---

Here we re-examine some of the
[matrix factorization results from the pancreas CEL-seq2 data](pancreas_another_look.html),
with the goal of understanding how best to *annotate* the pancreas
factors. As we will see, there isn't a single "one-size-fits-all"
strategy that works best, and so we recommend exploring different
annotation strategies. Also, careful interpretation of the matrix
factorization is discussed.

A side benefit of this investigation is to illustate some useful
plotting strategies, including the `annotation_heatmap()` function
from the [fastTopics][fastTopics package].

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

First, load the packages needed for this analysis.

```{r load-pkgs, message=FALSE}
library(Matrix)
library(flashier)
library(fastTopics)
library(ggplot2)
library(ggrepel)
library(cowplot)
```

Set the seed for reproducibility.

```{r set-seed}
set.seed(1)
```

Load the CEL-Seq2 pancreas data and the outputs generated by running
the `compute_pancreas_celseq2_factors.R` script. 

```{r load-data-celseq2}
load("../data/pancreas.RData")
load("../output/pancreas_celseq2_factors.RData")
i           <- which(sample_info$tech == "celseq2")
sample_info <- sample_info[i,]
counts      <- counts[i,]
sample_info <- transform(sample_info,celltype = factor(celltype))
```

We will first focus on the non-negative matrix factorization (NMF)
produced by flashier.

## Structure plot

The Structure plot (also shown in the previous analysis) shows that
many of the factors correspond closely to the cell-type assignments
that were estimated in the published analysis:

```{r structure-plot-flashier-nmf, fig.height=2, fig.width=8, results="hide", message=FALSE}
celltype <- sample_info$celltype
celltype <-
 factor(celltype,
        c("acinar","ductal","activated_stellate","quiescent_stellate",
		  "endothelial","macrophage","mast","schwann","alpha","beta",
		  "delta","gamma","epsilon"))
L <- fl_nmf_ldf$L
colnames(L) <- paste0("k",1:9)
structure_plot(L[,-1],grouping = celltype,gap = 10,perplexity = 70,n = Inf) +
  labs(y = "membership",fill = "factor",color = "factor")
```

Note that the first factor was omitted in the Structure plot because
it is a "baseline" factor, and not particularly interesting to look
at.

**A note about interpretation:** For visualization purposes, the
columns of the L matrix—the "membership matrix"—were scaled so that
the largest membership for a given factor (column) was always
exactly 1.  However, please note *this normalization is
arbitrary*. Therefore, *it is not meaningful to compare memberships
across factors (i.e., colors in the Structure plot); it is only
meaningful to compare memberships within a given factor (a single
color in the Structure plot).*

## Annotating the factors by "driving genes"

To illustrate annotating the factors, let's focus on factors 4, 5 and
6—these are the factors that largely capture the islet cells (alpha,
beta, *etc*). Let's consider two different selection strategies: (i)
choosing genes $j$ with the largest $f_{jk}$; (ii) choosing genes $j$
with the largest differences $f_{jk} - f_{jk'}$ with other factors $k'$
("distinctive genes"). These two selection strategies are implemented
in the `annotation_heatmap` function:

```{r annotation-plot-flashier-nmf, fig.height=3.25, fig.width=6, comment=""}
F <- fl_nmf_ldf$F
colnames(F) <- paste0("k",1:9)
kset <- paste0("k",4:6)
p1 <- annotation_heatmap(F,n = 8,dims = kset,
                         select_features = "largest",
						 font_size = 9) +
  labs(title = "select_features = \"largest\"") +
  theme(plot.title = element_text(face = "plain",size = 9))
p2 <- annotation_heatmap(F,n = 8,dims = kset,
                         select_features = "distinctive",
                         compare_dims = kset,
						 font_size = 9) +
  labs(title = "select_features = \"distinctive\"") +
  theme(plot.title = element_text(face = "plain",size = 9))
plot_grid(p1,p2,nrow = 1,ncol = 2)
```

Strategy (i) picks out some canonical marker genes for islet cells
such as *INS* for beta cells and *GCG* for alpha cells. But it also
picks out other genes that are highly expressed in multiple islet cell
types, such as *SCGN* and *TTR*. Strategy (ii) focusses more strongly
on genes that distinguish one cell type from another, and as a result
marker genes such as *MAFA* (beta cells) and *GC* (alpha cells) are
ranked more highly with this strategy.

Below, we take a closer look at the ranking of the genes based on
these two strategies, and suggest another simple visualization which
could be useful. (See: "A closer look at ranking genes by largest
versus distinctive".)

The better strategy will depend on the setting and on the goals of the
analysis, which is why the `annotation_heatmap` function provides both
options. These selection strategies can also reveal complementary
insights and so in many situations it may be better to use both.

### A more interpretable annotation heatmap

Above we sounded a note of caution about interpreting elements of L
across factors/columns. The same applies to the F matrix. To provide a
more even footing, above we employed the simple heuristic of scaling
the columns of F so that the maximum element in each column
was 1. That was helpful for selecting "distinctive" gene, but made the
effect sizes difficult to interpret. To produce more easily
interpretable effect sizes, we recommend visualizing this F matrix (in
this code, fl is a "flash" object, e.g., the return value from a call
to `flashier::flash()`):

```{r rescaling-F, eval=FALSE}
out <- ldf(fl)
F <- with(out,F %*% diag(D))
```

This is what this rescaled F matrix looks like for the pancreas data:

```{r annotation-plot-flashier-nmf-2, fig.height=3.25, fig.width=3.25, results="hide"}
genes <- c("INS","IAPP","NPTX2","MAFA","MEG3","ADCYAP1","PFKFB2", 
           "DLK1","GCG","GC","TTR","TM4SF4","FAP","LOXL4","ALDH1A1", 
           "CRYBA2","SST","AQP3","PPY","LEPR","EGR1","RBP4","DPYSL3", 
           "AKAP12")
F <- with(fl_nmf_ldf,F %*% diag(D))
colnames(F) <- paste0("k",1:9)
annotation_heatmap(F,select_features = genes,font_size = 9)
```

Visually, this plot looks quite similar to before, but now the effect
sizes are on a different scale. With this rescaling, the effect sizes
have the following interpretation:

<div style="margin:1em; padding:1em; border:1px solid black;">
$f_{jk}$ is (approximately) the log-fold change (LFC) of gene $j$ in
a hypothetical cell $i$ with the largest possible membership to factor
$k$ ($l_{ik} = 1$) relative to another hypothetical cell $i'$ with no
membership to factor $k$ ($l_{i'k} = 0$).
</div>

Also note that this same idea could have been also applied to the
other annotation heatmap (using the first selection strategy)—we showed
this with just the second annotation heatmap for illustration.

## Annotating the semi-NMF

Previously, we found the semi-non-negative matrix factorization
(semi-NMF) produced by flashier yields a more hierarchical
decomposition of the cell types, capturing structure at different
levels of cell-type-specifity:

```{r structure-plot-flashier-snmf, fig.height=2, fig.width=8, results="hide", message=FALSE}
L <- fl_snmf_ldf$L
colnames(L) <- paste0("k",1:9)
structure_plot(L[,-c(1,5)],grouping = celltype,gap = 10,
               perplexity = 70,n = Inf) +
  labs(y = "membership",fill = "factor",color = "factor")
```

As a result, we would expect that the factors themselves would tend to
pick more "distinctive" features; for example, factor 8 capturing
expression specific to dselta, gamma and epsilon cells doesn't need to
include the expression that is shared with alpha cells because factor
4 already captures this. Still, it is helpful to explore these two
selection strategies for the islet cell factors (3, 4 and 8) in the
annotation heatmap:

```{r annotation-plot-flashier-snmf, fig.height=3.25, fig.width=6, comment=""}
F <- fl_snmf_ldf$F
colnames(F) <- paste0("k",1:9)
kset <- paste0("k",c(3,4,8))
F <- F[,c(3,4,8,1,2,5,6,7,9)]
p1 <- annotation_heatmap(F,n = 8,dims = kset,
                         select_features = "largest",
                         feature_sign = "positive",
						 font_size = 9) +
  labs(title = "select_features = \"largest\"") +
  theme(plot.title = element_text(face = "plain",size = 9))
p2 <- annotation_heatmap(F,n = 8,dims = kset,
                         select_features = "distinctive",
                         compare_dims = kset,
                         feature_sign = "positive",
						 font_size = 9) +
  labs(title = "select_features = \"distinctive\"") +
  theme(plot.title = element_text(face = "plain",size = 9))
plot_grid(p1,p2,nrow = 1,ncol = 2)
```

Note that the F matrix in the semi-NMF allows for both positive and
negative log-fold changes.

## A closer look at ranking genes by largest vs. distinctive

Above, we compared gene selection strategies for some annotation
heatmaps of NMF results. Here we visualize how these two different
strategies result in two different gene rankings. And this
visualization may be useful on its own to annotate the factors.

First we define a couple of functions used to create some plots.

This function computes the "least extreme" (l.e.) effect differences
for a non-negative effects matrix:

```{r compute-le-diff}
compute_le_diff <- function (effects_matrix,
                             compare_dims = seq(1,ncol(effects_matrix))) {
  m <- ncol(effects_matrix)
  out <- effects_matrix
  for (i in 1:m) {
    dims <- setdiff(compare_dims,i)
    out[,i] <- effects_matrix[,i] - apply(effects_matrix[,dims],1,max)
  }
  return(out)
}
```

This function will be used to create the scatterplots:

```{r distinctive-gene-scatterplot}
distinctive_genes_scatterplot <- function (effects_matrix, k,
                                           effect_quantile_prob = 0.999,
                                           lediff_quantile_prob = 0.999) {
  lediff <- compute_le_diff(effects_matrix)
  genes  <- rownames(effects_matrix)
  pdat   <- data.frame(gene    = genes,
                       effect  = effects_matrix[,k],
                       lediff = lediff[,k])
  effect_quantile <- quantile(pdat$effect,effect_quantile_prob)
  lediff_quantile <- quantile(pdat$lediff,lediff_quantile_prob)
  i <- which(pdat$effect < effect_quantile & pdat$lediff < lediff_quantile)
  pdat[i,"gene"] <- NA
  return(ggplot(pdat,aes(x = effect,y = lediff,label = gene)) +
         geom_point(color = "dodgerblue") +
         geom_hline(yintercept = 0,color = "magenta",linetype = "dotted",
                    linewidth = 0.5) +
         geom_text_repel(color = "black",size = 2,
                         fontface = "italic",segment.color = "black",
                         segment.size = 0.25,min.segment.length = 0,
                         max.overlaps = Inf,na.rm = TRUE) +
         labs(x = "log-fold change",y = "l.e. difference") +
         theme_cowplot(font_size = 9))
}
```

Now we compare the two different gene rankings in the scatterplots for
factors 4, 5 and 6 of the flashier NMF result:

```{r distinctive-gene-scatterplots-flashier-nmf, fig.height=2.5, fig.width=7.5}
F <- fl_nmf_ldf$F
colnames(F) <- paste0("k",1:9)
kset <- paste0("k",4:6)
p1 <- distinctive_genes_scatterplot(F[,kset],"k4") + ggtitle("factor k4")
p2 <- distinctive_genes_scatterplot(F[,kset],"k5") + ggtitle("factor k5")
p3 <- distinctive_genes_scatterplot(F[,kset],"k6") + ggtitle("factor k6")
print(plot_grid(p1,p2,p3,nrow = 1,ncol = 3))
```

It is clear from these scatterplots that the rankings are very
different, and strikingly so for factor 5 representing alpha cells.
This means that many of the top-ranked genes for factor 5 (largest
increases in expression) also show very large increases in other islet
cells, e.g., *SCG5*.

[fastTopics]: https://github.com/stephenslab/fastTopics/
