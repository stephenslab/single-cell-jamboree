---
title: First attempts at factorizing the pancreas data set
author: Peter Carbonetto
output: workflowr::wflow_html
---

ADD TEXT HERE.

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

First, load the packages needed for this analysis.

```{r load-pkgs, message=FALSE}
library(Matrix)
library(fastTopics)
library(ggplot2)
library(cowplot)
```

Set the seed for reproducibility.

```{r set-seed}
set.seed(1)
```

This is a function I will use below to subsample the cell types that
have a lot of cells so that the rare cell types are more visible in
the Structure plots.

```{r subsample-cell-types}
subsample_cell_types <- function (x, n = 1000) {
  cells <- NULL
  groups <- levels(x)
  for (g in groups) {
    i  <-  which(x == g)
    n0 <- min(n,length(i))
    i  <- sample(i,n0)
    cells <- c(cells,i)
  }
  return(sort(cells))
}
```

Load the pancreas data set and the outputs generated from running the
`compute_pancreas_factors.R` and `compute_pancreas_factors2.R` scripts.

```{r load-data}
load("../data/pancreas.RData")
load("../output/pancreas_factors.RData")
timings0 <- timings
load("../output/pancreas_factors2.RData")
timings <- c(timings0,timings)
```

This is a summary of the running times (in hours) for the model
fitting (focus on the "elapsed" column):

```{r compare-timings}
do.call(rbind,timings)/360
```

Fitting the topic model ("fasttopics") and the three flashier models
("NMF", "semi-NMF", "NMF-CC") each took 1-2 hours. Fitting the NMF
model using the NNLM package was much, much faster (about 2 minutes).
*Note:* Below I'll explain what is the "NMF-CC" model.

## flashier NMF

The empirical Bayes NMF compellingly identifies several factors
corresponding very well to both cell type and sequencing technology:

```{r structure-plots-flashier-nmf, results="hide", message=FALSE, fig.height=5.5, fig.width=8}
cells <- subsample_cell_types(sample_info$celltype,n = 500)
L <- fl_nmf_ldf$L
k <- ncol(L)
colnames(L) <- paste0("k",1:k)
batch_factors    <- c(2:5,7:8,20)
celltype_factors <- c(6,11:19,21)
other_factors    <- c(1,9:10,22:23)
celltype <- sample_info$celltype
celltype <-
 factor(celltype,
        c("acinar","activated_stellate","quiescent_stellate","alpha","beta",
	  	  "delta","gamma","epsilon","ductal","endothelial","macrophage",
		  "mast","schwann","t_cell"))
p1 <- structure_plot(L,topics = batch_factors,grouping = sample_info$tech,
                     gap = 10,perplexity = 70) +
  labs(y = "membership",title = "data-set factors",
       fill = "factor",color = "factor")
p2 <- structure_plot(L[cells,],topics = celltype_factors,
                     grouping = celltype[cells],gap = 25,
					 n = Inf,perplexity = 70) +
  labs(y = "membership",title = "cell-type factors",
       fill = "factor",color = "factor")
p3 <- structure_plot(L[cells,],topics = other_factors,
                     grouping = celltype[cells],gap = 25,
					 n = Inf,perplexity = 70) +
  labs(y = "membership",title = "other factors",
       fill = "factor",color = "factor")
plot_grid(p1,p2,p3,nrow = 3,ncol = 1)
```

Note that the number of factors, 23, was automatically determined by
flashier. Some structure was missed by this factorization and it is
possible that forcing flashier to estimate more factors would have
also picked up other intersting structure. Nonetheless, the flashier
NMF seems to cope well here with separating the cell types from the
batch effects.

To contrast this flashier result with a standard NMF (generated by
NNLM), the factors in the standard NMF does not capture nearly as well
the cell types and the batch structure. We don't have the ground
truth, but better correspondence between the provided cell annotations
and the flashier result point toward the flashier fit being better.

```{r structure-plots-nnlm, results="hide", message=FALSE, fig.height=5.5, fig.width=8}
scale_cols <- function (A, b)
  t(t(A) * b)
W <- nmf$W
k <- ncol(W)
d <- apply(W,2,max)
W <- scale_cols(W,1/d)
colnames(W) <- paste0("k",1:k)
batch_factors    <- c(1,6,7,10,13,14,16:18)
celltype_factors <- c(2,5,8,9,11,12,15,20:23)
other_factors    <- c(3,4,19)
p1 <- structure_plot(W[,batch_factors],grouping = sample_info$tech,
                     gap = 10,perplexity = 70) +
  labs(y = "membership",title = "data-set factors",
       fill = "factor",color = "factor")
p2 <- structure_plot(W[cells,celltype_factors],grouping = celltype[cells],
                     gap = 25,n = Inf,perplexity = 70) +
  labs(y = "membership",title = "cell-type factors",
       fill = "factor",color = "factor")
p3 <- structure_plot(W[cells,other_factors],grouping = celltype[cells],
                     gap = 25,n = Inf,perplexity = 70) +
  labs(y = "membership",title = "other factors",
       fill = "factor",color = "factor")
plot_grid(p1,p2,p3,nrow = 3,ncol = 1)
```

It is interesting that the flashier NMF factors are much more sparse:

```{r flashier-vs-nnlm, fig.height=2.5, fig.width=2.5}
pdat <- data.frame(flashier = quantile(L,seq(0,1,0.01)),
                   nnlm     = quantile(W,seq(0,1,0.01)))
ggplot(pdat,aes(x = nnlm,y = flashier)) +
  geom_line() +
  geom_point() +
  geom_abline(slope = 1,intercept = 0,color = "magenta",linetype = "dotted") +
  theme_cowplot(font_size = 10)
```
