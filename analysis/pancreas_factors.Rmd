---
title: Various attempts at factorizing the pancreas data set
author: Peter Carbonetto
output: workflowr::wflow_html
---

This goal of this analysis is to apply a few different matrix
factorization approaches to the [pancreas data set](pancreas.html) and
assess how well they work for this data set.

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

First, load the packages needed for this analysis.

```{r load-pkgs, message=FALSE}
library(Matrix)
library(fastTopics)
library(ggplot2)
library(cowplot)
```

Set the seed for reproducibility.

```{r set-seed}
set.seed(1)
```

This is a function I will use below to subsample the cell types that
have a lot of cells so that the rare cell types are more visible in
the Structure plots.

```{r subsample-cell-types}
subsample_cell_types <- function (x, n = 1000) {
  cells <- NULL
  groups <- levels(x)
  for (g in groups) {
    i  <-  which(x == g)
    n0 <- min(n,length(i))
    i  <- sample(i,n0)
    cells <- c(cells,i)
  }
  return(sort(cells))
}
```

Load the pancreas data set and the outputs generated from running the
`compute_pancreas_factors.R` and `compute_pancreas_factors2.R` scripts.

```{r load-data}
load("../data/pancreas.RData")
load("../output/pancreas_factors.RData")
timings0 <- timings
load("../output/pancreas_factors2.RData")
timings <- c(timings0,timings)
```

This is a summary of the running times (in hours) for the model
fitting (focus on the "elapsed" column):

```{r compare-timings}
round(do.call(rbind,timings)/60^2,digits = 2)
```

Fitting the topic model ("fasttopics") and the three flashier models
("NMF", "semi-NMF", "NMF-CC") each took 1-2 hours. Fitting the NMF
model using the NNLM package was much, much faster (about 7 minutes).
*Note:* Below I'll explain what is the "NMF-CC" model.

### flashier NMF

The empirical Bayes NMF compellingly identifies several factors
corresponding very well to both cell type and sequencing technology:

```{r structure-plots-flashier-nmf, results="hide", message=FALSE, fig.height=5.5, fig.width=8}
cells <- subsample_cell_types(sample_info$celltype,n = 500)
L <- fl_nmf_ldf$L
k <- ncol(L)
colnames(L) <- paste0("k",1:k)
batch_factors    <- c(2:5,7:8,20)
celltype_factors <- c(6,11:19,21)
other_factors    <- c(1,9:10,22:23)
celltype <- sample_info$celltype
celltype <-
 factor(celltype,
        c("acinar","activated_stellate","quiescent_stellate","alpha","beta",
	  	  "delta","gamma","epsilon","ductal","endothelial","macrophage",
		  "mast","schwann","t_cell"))
p1 <- structure_plot(L,topics = batch_factors,grouping = sample_info$tech,
                     gap = 10,perplexity = 70) +
  labs(y = "membership",title = "data-set factors",
       fill = "factor",color = "factor")
p2 <- structure_plot(L[cells,],topics = celltype_factors,
                     grouping = celltype[cells],gap = 25,
					 n = Inf,perplexity = 70) +
  labs(y = "membership",title = "cell-type factors",
       fill = "factor",color = "factor")
p3 <- structure_plot(L[cells,],topics = other_factors,
                     grouping = celltype[cells],gap = 25,
					 n = Inf,perplexity = 70) +
  labs(y = "membership",title = "other factors",
       fill = "factor",color = "factor")
plot_grid(p1,p2,p3,nrow = 3,ncol = 1)
```

Note that the number of factors, 23, was automatically determined by
flashier. Some structure was missed by this factorization and it is
possible that forcing flashier to estimate more factors would have
also picked up other intersting structure. Nonetheless, the flashier
NMF seems to cope well here with separating the cell types from the
batch effects.

### NMF (NNLM)

To contrast this flashier result with a standard NMF (generated by
NNLM), the factors in the standard NMF does not capture nearly as well
the cell types and the batch structure. We don't have the ground
truth, but better correspondence between the provided cell annotations
and the flashier result point toward the flashier fit being better.

```{r structure-plots-nnlm, results="hide", message=FALSE, fig.height=5.5, fig.width=8}
scale_cols <- function (A, b)
  t(t(A) * b)
W <- nmf$W
k <- ncol(W)
d <- apply(W,2,max)
W <- scale_cols(W,1/d)
colnames(W) <- paste0("k",1:k)
batch_factors    <- c(1,6,7,10,13,14,16:18)
celltype_factors <- c(2,5,8,9,11,12,15,20:23)
other_factors    <- c(3,4,19)
p1 <- structure_plot(W[,batch_factors],grouping = sample_info$tech,
                     gap = 10,perplexity = 70) +
  labs(y = "membership",title = "data-set factors",
       fill = "factor",color = "factor")
p2 <- structure_plot(W[cells,celltype_factors],grouping = celltype[cells],
                     gap = 25,n = Inf,perplexity = 70) +
  labs(y = "membership",title = "cell-type factors",
       fill = "factor",color = "factor")
p3 <- structure_plot(W[cells,other_factors],grouping = celltype[cells],
                     gap = 25,n = Inf,perplexity = 70) +
  labs(y = "membership",title = "other factors",
       fill = "factor",color = "factor")
plot_grid(p1,p2,p3,nrow = 3,ncol = 1)
```

It is interesting that the flashier NMF factors are much more sparse:

```{r flashier-vs-nnlm, fig.height=2.5, fig.width=2.5}
pdat <- data.frame(flashier = quantile(L,seq(0,1,0.01)),
                   nnlm     = quantile(W,seq(0,1,0.01)))
ggplot(pdat,aes(x = nnlm,y = flashier)) +
  geom_line() +
  geom_point() +
  geom_abline(slope = 1,intercept = 0,color = "magenta",linetype = "dotted") +
  theme_cowplot(font_size = 10)
```

### Topic model (fastTopics)

The topic model (again with 23 factors/topics) has more difficulty
than NMF separating the cell types from the batch/data-set effects:

```{r structure-plots-fasttopics, results="hide", message=FALSE, fig.height=5.5, fig.width=8}
L <- poisson2multinom(pnmf)$L
batch_topics     <- c(2,5,6,11,12)
celltype_topics  <- c(4,9,8,15,16,17,18,19,20)
celltype_topics2 <- c(1,3,7,10,13,14,21,22,23)
p1 <- structure_plot(L[,batch_topics],grouping = sample_info[,"tech"],
                     gap = 10,perplexity = 70) +
  ggtitle("data-set topics")
p2 <- structure_plot(L[cells,celltype_topics],grouping = celltype[cells],
                     gap = 25,perplexity = 70,n = Inf) +
  ggtitle("cell-type topics")					 
p3 <- structure_plot(L[cells,celltype_topics2],grouping = celltype[cells],
                     gap = 25,perplexity = 70,n = Inf) +
  ggtitle("more cell-type topics")					 
plot_grid(p1,p2,p3,nrow = 3,ncol = 1)
```

For example, topics 3, 10 and 23 have identified cell types specific
to the Fluidigm C1 data only, whereas it would be preferrable to
separate these data-set effects from the cell types:

```{r structure-plots-fasttopics-fluidicmg1, results="hide", message=FALSE, fig.height=1.9, fig.width=6}
i <- which(sample_info$tech == "fluidigmc1")
structure_plot(L[i,celltype_topics2],grouping = celltype[i],
               gap = 5,perplexity = 30,n = Inf)
```

### Flashier semi-NMF

The semi-NMF fit generated by flashier seems promising in that it
separates data-set structure from cell-type structure, but the
individual factors seem at first glance to be harder to interpret than
the flashier NMF factors:

```{r structure-plots-flashier-snmf, results="hide", message=FALSE, warning=FALSE, fig.height=5.5, fig.width=8}
L <- fl_snmf_ldf$L
colnames(L) <- paste0("k",1:k)
batch_factors    <- c(4:6,11,22)
celltype_factors <- c(3,7:10,12,16:18,20,21,23)
other_factors    <- c(1:2,13:15,19)
p1 <- structure_plot(L[,batch_factors],grouping = sample_info$tech,gap = 10,
                     perplexity = 70) +
  ylim(0,2) +
  labs(y = "membership",title = "data-set factors",
       fill = "factor",color = "factor")
p2 <- structure_plot(L[cells,celltype_factors],
                     grouping = celltype[cells],
                     gap = 25,n = Inf,perplexity = 70) +
  ylim(0,2) +
  labs(y = "membership",title = "cell-type factors",
       fill = "factor",color = "factor")
p3 <- structure_plot(L[cells,other_factors],
                     grouping = celltype[cells],
                     gap = 25,n = Inf,perplexity = 70) +
  ylim(0,2) +
  labs(y = "membership",title = "other factors",
       fill = "factor",color = "factor")
plot_grid(p1,p2,p3,nrow = 3,ncol = 1)
```

### flashier NMF with "cross-cutting factors"

Finally, mainly to see whether it was possible, I also tried fitting
an NMF using flashier in which there were additional "cross-cutting
factors" (CC) that could capture both increases and decreases in
expression, with the hope that these CC factors could better capture
the data-set effects. It is unclear this provided an improvement over
the flashier NMF results (which were already quite good), but I think it is
intruiging this is a possibility in flashier.

```{r structure-plots-flashier-nmf-cc, results="hide", message=FALSE, warning=FALSE, fig.height=5.5, fig.width=8}
set.seed(1)
L <- fl_nmf_cc_ldf$L
k <- ncol(L)
colnames(L) <- paste0("k",1:k)
batch_factors    <- c(1,2:8)
celltype_factors <- c(9,12,13:21)
other_factors    <- c(10,11,22:23)
p1 <- structure_plot(L,topics = batch_factors,grouping = sample_info$tech,
                     gap = 10,perplexity = 70) +
  labs(y = "membership",title = "data-set factors",
       fill = "factor",color = "factor")
p2 <- structure_plot(L[cells,],topics = celltype_factors,
                     grouping = celltype[cells],
                     gap = 25,n = Inf,perplexity = 70) +
  labs(y = "membership",title = "cell-type factors",
       fill = "factor",color = "factor")
p3 <- structure_plot(L[cells,],topics = other_factors,
                     grouping = celltype[cells],
                     gap = 25,n = Inf,perplexity = 70) +
  labs(y = "membership",title = "other factors",
       fill = "factor",color = "factor")
plot_grid(p1,p2,p3,nrow = 3,ncol = 1)
```


