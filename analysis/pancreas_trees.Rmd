---
title: Tree-based representations of the pancreas data
author: Peter Carbonetto
output: workflowr::wflow_html
---

Here we build on the
["another look" analysis](pancreas_another_look.html) and explore
tree-based representations of the pancreas data.

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

First, load the packages needed for this analysis.

```{r load-pkgs, message=FALSE}
library(Matrix)
library(fastTopics)
library(ggplot2)
library(cowplot)
library(ape)
```

Set the seed for reproducibility.

```{r set-seed}
set.seed(1)
```

## CEL-Seq2 data

Load the CEL-Seq2 pancreas data and the outputs generated by running
the `compute_pancreas_celseq2_factors.R` script.

```{r load-data-celseq2}
load("../data/pancreas.RData")
load("../output/pancreas_celseq2_factors.RData")
i           <- which(sample_info$tech == "celseq2")
sample_info <- sample_info[i,]
counts      <- counts[i,]
sample_info <- transform(sample_info,celltype = factor(celltype))
```

### Topic model (fastTopics)

Here is the topic model (with 9 topics):

```{r structure-plot-fasttopics-celseq2, fig.height=2, fig.width=8, results="hide", message=FALSE}
celltype <- sample_info$celltype
celltype <-
 factor(celltype,
        c("acinar","ductal","activated_stellate","quiescent_stellate",
		  "endothelial","macrophage","mast","schwann","alpha","beta",
		  "delta","gamma","epsilon"))
L <- poisson2multinom(pnmf)$L
structure_plot(L,grouping = celltype,gap = 20,perplexity = 70,n = Inf)
```

Fit a tree to the topics using the neighbor-joining tree algorithm:

```{r tree-fasttopics-celseq2, fig.height=2, fig.width=3}
par(mar = c(1,1,1,1))
k <- 9
F <- poisson2multinom(pnmf)$F
D <- as.matrix(dist(t(F)))
rownames(D) <- paste0("k",1:k)
colnames(D) <- paste0("k",1:k)
tr <- nj(D)
tr$edge.length <- abs(tr$edge.length)
plot(tr,cex = 0.75,edge.width = 1.5,adj = 5,font = 1)
```

### Flashier NMF

Here is the empirical Bayes NMF fit (with 9 factors):

```{r structure-plot-flashier-nmf-celseq2, fig.height=2, fig.width=8, results="hide", message=FALSE}
L <- fl_nmf_ldf$L
k <- ncol(L)
colnames(L) <- paste0("k",1:k)
structure_plot(L[,-1],grouping = celltype,gap = 20,perplexity = 70,n = Inf) +
  labs(y = "membership",fill = "factor",color = "factor")
```

Fit a tree to these factors using the neighbor-joining tree algorithm:

```{r tree-flashier-nmf-celseq, fig.height=2, fig.width=3}
par(mar = c(1,1,1,1))
k  <- 9
ks <- 2:9
D  <- as.matrix(dist(t(fl_nmf_ldf$F)))
rownames(D) <- paste0("k",1:k)
colnames(D) <- paste0("k",1:k)
tr <- nj(D[ks,ks])
tr$edge.length <- abs(tr$edge.length)
plot(tr,cex = 0.75,edge.width = 1.5,adj = 5,font = 1)
```

### NMF (NNLM)

Let's now have a look at the "vanilla" NMF (produced by the NNLM
package). As before, this NMF has 9 factors.

```{r structure-plot-nnlm-celseq2, fig.height=2, fig.width=8, results="hide", message=FALSE}
scale_cols <- function (A, b)
  t(t(A) * b)
W <- nmf$W
k <- ncol(W)
d <- apply(W,2,max)
W <- scale_cols(W,1/d)
colnames(W) <- paste0("k",1:k)
structure_plot(W,grouping = celltype,gap = 20,perplexity = 70,n = Inf) +
  labs(y = "membership",fill = "factor",color = "factor")
```

Fit a tree to these factors using the neighbor-joining tree algorithm:

```{r tree-nnlm-celseq, fig.height=2, fig.width=3}
par(mar = c(1,1,1,1))
H <- nmf$H
d <- apply(H,2,max)
H <- scale_cols(H,1/d)
D <- as.matrix(dist(H))
rownames(D) <- paste0("k",1:k)
colnames(D) <- paste0("k",1:k)
tr <- nj(D)
tr$edge.length <- abs(tr$edge.length)
plot(tr,cex = 0.75,edge.width = 1.5,adj = 5,font = 1)
```

## Smart-seq2 data

Load the Smart-Seq2 data and the outputs generated from running the
`compute_pancreas_smartseq2_factors.R` script.

```{r load-data-smartseq2, eval=FALSE}
load("../data/pancreas.RData")
load("../output/pancreas_smartseq2_factors.RData")
i           <- which(sample_info$tech == "smartseq2")
sample_info <- sample_info[i,]
counts      <- counts[i,]
sample_info <- transform(sample_info,celltype = factor(celltype))
celltype <- sample_info$celltype
celltype <-
 factor(celltype,
        c("acinar","ductal","activated_stellate","quiescent_stellate",
		  "endothelial","macrophage","mast","schwann","alpha",
		  "beta","delta","gamma","epsilon"))
```

### Topic model (fastTopics)

Here is the topic model with 9 topics:

```{r structure-plot-fasttopics-smartseq2, fig.height=2, fig.width=8, results="hide", message=FALSE}
L <- poisson2multinom(pnmf)$L
structure_plot(L,grouping = celltype,gap = 20,perplexity = 70,n = Inf)
```

Fit a tree to the topics using the neighbor-joining tree algorithm:

```{r tree-fasttopics-smartseq2, fig.height=2, fig.width=3}
par(mar = c(1,1,1,1))
k <- 9
F <- poisson2multinom(pnmf)$F
D <- as.matrix(dist(t(F)))
rownames(D) <- paste0("k",1:k)
colnames(D) <- paste0("k",1:k)
tr <- nj(D)
tr$edge.length <- abs(tr$edge.length)
plot(tr,cex = 0.75,edge.width = 1.5,adj = 5,font = 1)
```

### Flashier NMF

Here is the empirical Bayes NMF fit (with 9 factors):

```{r structure-plot-flashier-nmf-smartseq2, fig.height=4.25, fig.width=8, results="hide", message=FALSE}
L <- fl_nmf_ldf$L
k <- ncol(L)
colnames(L) <- paste0("k",1:k)
celltype_factors  <- 2:7
other_factors <- c(1,8,9)
p1 <- structure_plot(L[,celltype_factors],grouping = celltype,gap = 20,
                     perplexity = 70,n = Inf) +
  labs(y = "membership",fill = "factor",color = "factor",
       title = "cell-type factors")
other_colors <- c("#66c2a5","#fc8d62","#8da0cb")
p2 <- structure_plot(L[,other_factors],grouping = celltype,gap = 20,
                     perplexity = 70,n = Inf) +
  labs(y = "membership",fill = "factor",color = "factor",
       title = "other factors") +
  scale_color_manual(values = other_colors) +
  scale_fill_manual(values = other_colors)
plot_grid(p1,p2,nrow = 2,ncol = 1)
```

Fit a tree to the cell-type factors using the neighbor-joining tree algorithm:

```{r tree-flashier-nmf-smartseq2, fig.height=2, fig.width=3}
par(mar = c(1,1,1,1))
k  <- 9
D  <- as.matrix(dist(t(fl_nmf_ldf$F)))
rownames(D) <- paste0("k",1:k)
colnames(D) <- paste0("k",1:k)
tr <- nj(D[celltype_factors,celltype_factors])
tr$edge.length <- abs(tr$edge.length)
plot(tr,cex = 0.75,edge.width = 1.5,adj = 5,font = 1)
```

### NMF (NNLM)

This is the NMF decomposition (with 9 factors):

```{r structure-plots-nnlm-smartseq2, results="hide", message=FALSE, fig.height=4.25, fig.width=8}
scale_cols <- function (A, b)
  t(t(A) * b)
W <- nmf$W
k <- ncol(W)
d <- apply(W,2,max)
W <- scale_cols(W,1/d)
colnames(W) <- paste0("k",1:k)
celltype_factors  <- c(3:6,8,9)
other_factors <- c(1,2,7)
p1 <- structure_plot(W[,celltype_factors],grouping = celltype,
                     gap = 20,perplexity = 70,n = Inf) +
  labs(y = "membership",fill = "factor",color = "factor",
       title = "cell-type factors")
p2 <- structure_plot(W[,other_factors],grouping = celltype,
                     gap = 20,perplexity = 70,n = Inf) +
  scale_color_manual(values = other_colors) +
  scale_fill_manual(values = other_colors) +
  labs(y = "membership",fill = "factor",color = "factor",
       title = "other factors")
plot_grid(p1,p2,nrow = 2,ncol = 1)
```

Fit a tree to the cell-type factors using the neighbor-joining tree algorithm:

```{r tree-nnlm-smartseq2, fig.height=2, fig.width=3}
par(mar = c(1,1,1,1))
H <- nmf$H
d <- apply(H,2,max)
H <- scale_cols(H,1/d)
D <- as.matrix(dist(H))
rownames(D) <- paste0("k",1:k)
colnames(D) <- paste0("k",1:k)
tr <- nj(D[celltype_factors,celltype_factors])
tr$edge.length <- abs(tr$edge.length)
plot(tr,cex = 0.75,edge.width = 1.5,adj = 5,font = 1)
```

[muraro-2016]: https://doi.org/10.1016/j.cels.2016.09.002
[segerstolpe-2016]: http://dx.doi.org/10.1016/j.cmet.2016.08.020
