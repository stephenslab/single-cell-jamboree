---
title: A another look at matrix factorization for the pancreas data
author: Peter Carbonetto
output: workflowr::wflow_html
---

[The previous analysis](pancreas_factors.html) applied different
matrix factorization approaches to the
[full pancreas data set](pancreas.html). A key challenge in analyzing
the full pancreas data set is that there are large batch or data-set
effects, which some matrix factorization approaches have difficulty
dealing with (particularly the topic model). Here we look more closely
at a couple of the individual data sets to highlight better how the
different factorizations yield different representations of the
underlying structure in the cells without the added complication of
dealing with the batch effects.

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

First, load the packages needed for this analysis.

```{r load-pkgs, message=FALSE}
library(Matrix)
library(fastTopics)
library(ggplot2)
library(cowplot)
```

Set the seed for reproducibility.

```{r set-seed}
set.seed(1)
```

## CEL-Seq2 data

Let's start with the "CEL-Seq2" data from [the Muraro et al 2016
paper][muraro-2016]. (The data were generated using the CEL-Seq2
protocol, hence the name.)

First load the CEL-Seq2 pancreas data and the outputs generated by
running the `compute_pancreas_celseq2_factors.R` script.

```{r load-data-celseq2}
load("../data/pancreas.RData")
load("../output/pancreas_celseq2_factors.RData")
i           <- which(sample_info$tech == "celseq2")
sample_info <- sample_info[i,]
counts      <- counts[i,]
sample_info <- transform(sample_info,celltype = factor(celltype))
```

For fair comparison all the matrix factorizations were generated with
9 factors or topics.

### Topic model (fastTopics)

Here is the topic model with 9 topics:

```{r structure-plot-fasttopics-celseq2, fig.height=2, fig.width=8, results="hide", message=FALSE}
celltype <- sample_info$celltype
celltype <-
 factor(celltype,
        c("acinar","ductal","activated_stellate","quiescent_stellate",
		  "endothelial","macrophage","mast","schwann","alpha","beta",
		  "delta","gamma","epsilon"))
L <- poisson2multinom(pnmf)$L
structure_plot(L,grouping = celltype,gap = 20,perplexity = 70,n = Inf)
```

Most of the topics identify individual cell types or subsets of
similar cell types. The topics also identify some substructures within
and across cell types, e.g., topics 2 and 7. Most of the smaller cell
types are not captured as a separate topic.

### Flashier NMF

Let's now compare the topic model to the empirical Bayes NMF result
(with 9 factors).

I omit the first factor from the Structure plot because it is a
"baseline" factor, and therefore not interesting to look at:

```{r structure-plot-flashier-nmf-celseq2, fig.height=2, fig.width=8, results="hide", message=FALSE}
L <- fl_nmf_ldf$L
k <- ncol(L)
colnames(L) <- paste0("k",1:k)
structure_plot(L[,-1],grouping = celltype,gap = 20,perplexity = 70,n = Inf) +
  labs(y = "membership",fill = "factor",color = "factor")
```

It is interesting that the EBNMF factors distinguish some of the rare
cell types, but do not distinguish as well among some of the islet
cells (e.g., delta and gamma), even though they are quite abundant.
It seems that these methods are each adept at identifying different
types of structure.

### NMF (NNLM)

Let's now have a look at the "vanilla" NMF (produced by the NNLM
package). As before, this NMF has 9 factors.

```{r structure-plot-nnlm-celseq2, fig.height=2, fig.width=8, results="hide", message=FALSE}
scale_cols <- function (A, b)
  t(t(A) * b)
W <- nmf$W
k <- ncol(W)
d <- apply(W,2,max)
W <- scale_cols(W,1/d)
colnames(W) <- paste0("k",1:k)
structure_plot(W,grouping = celltype,gap = 20,perplexity = 70,n = Inf) +
  labs(y = "membership",fill = "factor",color = "factor")
```

Unlike the EBNMF results, there is no single factor that acts as a
"baseline". Some of the rarer cell types are missed by this NMF. It is
also interesting that it has identified a single factor (k = 4)
corresponding to all islet cells. Oddly, it seems to have identified
factors that are active in the same cells, such as factors 3 and 6, as
well as 7 and 8. So the NMF and EBNMF results are surprisingly
different.

### Flashier semi-NMF

The semi-NMF decomposition produced by flashier is interesting because
it identifies not only cell-type-specific factors (e.g., factors 6,
7, 9), but also factors capturing expression programs common to several
similar cell types (e.g., factors 2, 4, 8). 

```{r structure-plot-flashier-snmf-celseq2, fig.height=3, fig.width=8, results="hide", message=FALSE}
L <- fl_snmf_ldf$L
k <- ncol(L)
colnames(L) <- paste0("k",1:k)
structure_plot(L[,-c(1,5)],grouping = celltype,gap = 20,
               perplexity = 70,n = Inf) +
  labs(y = "membership",fill = "factor",color = "factor")
```

In other words, the semi-NMF is capturing structure at different
levels of cell-type-specifity, achieving a cell-type "hierarchy" of
sorts. Note that I removed two factors (1 and 5) from the Structure
plot because they were active to varying degreees in all cells.

## Smart-seq2 data

The "Smart-seq2" data from
[the Segerstolpe et al 2016 paper][segerstolpe-2016] is another
interesting pancreas data set that is roughly the same size as the
CEL-Seq2 data set, and contains transcriptional profiles from some of
the same cell types. (These data were generated using the "Smart-seq2"
protocol, hence the name.) Let's redo the comparisons above on this
data set.

First load the Smart-Seq2 data and the outputs generated from running
the `compute_pancreas_smartseq2_factors.R` script.

```{r load-data-smartseq2}
load("../data/pancreas.RData")
load("../output/pancreas_smartseq2_factors.RData")
i           <- which(sample_info$tech == "smartseq2")
sample_info <- sample_info[i,]
counts      <- counts[i,]
sample_info <- transform(sample_info,celltype = factor(celltype))
celltype <- sample_info$celltype
celltype <-
 factor(celltype,
        c("acinar","ductal","activated_stellate","quiescent_stellate",
		  "endothelial","macrophage","mast","schwann","alpha",
		  "beta","delta","gamma","epsilon"))
```


### Topic model (fastTopics)

Here is the topic model with 9 topics:

```{r structure-plot-fasttopics-smartseq2, fig.height=2, fig.width=8, results="hide", message=FALSE}
L <- poisson2multinom(pnmf)$L
structure_plot(L,grouping = celltype,gap = 20,perplexity = 70,n = Inf)
```

Broadly speaking, the topic model picks up very similar structure to
the CEL-seq2 data. However, there are also some important
differences. The most noticeable differences are that: (1) it does not
identify a separate topic for ductal vs. stellate cells, etc; (2)
there are at least two additional topics (topics 1 and 8) capturing
additional variation across cell types that is not specific to cell
type, and represents some additional variation in expression. *It is
possible that this additional variation in expression is due to
differences in sex, age, BMI and/or disease status (T2D vs. healthy)
among the 10 donors.*

### Flashier NMF

Although the EBNMF result for the Smart-seq2 data set has some
differences from the EBNMF result for the CEL-seq2 data set, there are
some common trends: (1) it is better able to capture strucuture in the
less abundance cell types (e.g., stellate cells); (2) the factors do
not as clearly distinguish among the islet cells as the
topics. Because there is other systematic variation in expression that
is not cell-type-specific, this is picked up by several factors
(factors 1, 8 and 9).

```{r structure-plot-flashier-nmf-smartseq2, fig.height=4.25, fig.width=8, results="hide", message=FALSE}
L <- fl_nmf_ldf$L
k <- ncol(L)
colnames(L) <- paste0("k",1:k)
celltype_topics  <- 2:7
other_topics <- c(1,8,9)
p1 <- structure_plot(L[,celltype_topics],grouping = celltype,gap = 20,
                     perplexity = 70,n = Inf) +
  labs(y = "membership",fill = "factor",color = "factor",
       title = "cell-type factors")
other_colors <- c("#66c2a5","#fc8d62","#8da0cb")
p2 <- structure_plot(L[,other_topics],grouping = celltype,gap = 20,
                     perplexity = 70,n = Inf) +
  labs(y = "membership",fill = "factor",color = "factor",
       title = "other factors") +
  scale_color_manual(values = other_colors) +
  scale_fill_manual(values = other_colors)
plot_grid(p1,p2,nrow = 2,ncol = 1)
```

### NMF (NNLM)

In the Smart-seq2 data set, the NMF decomposition generated by NNLM is
remarkaby similar to the flashier NMF decomposition:

```{r structure-plots-nnlm-smartseq2, results="hide", message=FALSE, fig.height=4.25, fig.width=8}
scale_cols <- function (A, b)
  t(t(A) * b)
W <- nmf$W
k <- ncol(W)
d <- apply(W,2,max)
W <- scale_cols(W,1/d)
colnames(W) <- paste0("k",1:k)
celltype_topics  <- c(3:6,8,9)
other_topics <- c(1,2,7)
p1 <- structure_plot(W[,celltype_topics],grouping = celltype,
                     gap = 20,perplexity = 70,n = Inf) +
  labs(y = "membership",fill = "factor",color = "factor",
       title = "cell-type factors")
p2 <- structure_plot(W[,other_topics],grouping = celltype,
                     gap = 20,perplexity = 70,n = Inf) +
  scale_color_manual(values = other_colors) +
  scale_fill_manual(values = other_colors) +
  labs(y = "membership",fill = "factor",color = "factor",
       title = "other factors")
plot_grid(p1,p2,nrow = 2,ncol = 1)
```

### Flashier semi-NMF

The empirical Bayes semi-NMF decomposition is interesting in
particular because it is capturing common expression patterns among
some of the cell types (e.g., acinar, ductal, stellate) as well as
their differences (e.g., separate factors for acinar, stellate, and
quiescent stellate cells), and therefore the semi-NMF factors may
represent particularly interpretable gene expression programs.

```{r structure-plots-flashier-snmf-smartseq2, results="hide", message=FALSE, warning=FALSE, fig.height=4.25, fig.width=8}
L <- fl_snmf_ldf$L
k <- ncol(L)
colnames(L) <- paste0("k",1:k)
celltype_topics  <- c(3,4,6,7,9)
other_topics <- c(1,5,8)
p1 <- structure_plot(L[,celltype_topics],grouping = celltype,
                     gap = 20,perplexity = 70,n = Inf) +
  labs(y = "membership",fill = "factor",color = "factor",
       title = "cell-type factors")
p2 <- structure_plot(L[,other_topics],grouping = celltype,
                     gap = 20,perplexity = 70,n = Inf) +
  scale_color_manual(values = other_colors) +
  scale_fill_manual(values = other_colors) +
  labs(y = "membership",fill = "factor",color = "factor",
       title = "other factors")
plot_grid(p1,p2,nrow = 2,ncol = 1)
```

[muraro-2016]: https://doi.org/10.1016/j.cels.2016.09.002
[segerstolpe-2016]: http://dx.doi.org/10.1016/j.cmet.2016.08.020
