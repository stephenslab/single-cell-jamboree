---
title: A another look at matrix factorization for the pancreas data
author: Peter Carbonetto
output: workflowr::wflow_html
---

[The previous analysis](pancreas_factors.html) applied different
matrix factorization approaches to the
[full pancreas data set](pancreas.html). A key challenge in analyzing
the full pancreas data set is that there are large batch or data-set
effects, which some matrix factorization approaches have difficulty
dealing with (particularly the topic model). Here we look more closely
at a couple of the individual data sets to highlight better how the
different factorizations yield different representations of the
underlying structure in the cells without the added complication of
dealing with the batch effects.

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

First, load the packages needed for this analysis.

```{r load-pkgs, message=FALSE}
library(Matrix)
library(fastTopics)
library(ggplot2)
library(cowplot)
```

Set the seed for reproducibility.

```{r set-seed}
set.seed(1)
```

## CEL-Seq2 data

Let's start with the "CEL-Seq2" data from [the Muraro et al 2016
paper][muraro-2016]. (The data were generated using the CEL-Seq2
protocol.)

First load the CEL-Seq2 pancreas data and the outputs generated by
running the `compute_pancreas_celseq2_factors.R` script.

```{r load-data}
load("../data/pancreas.RData")
load("../output/pancreas_celseq2_factors.RData")
i           <- which(sample_info$tech == "celseq2")
sample_info <- sample_info[i,]
counts      <- counts[i,]
sample_info <- transform(sample_info,celltype = factor(celltype))
```

For fair comparison all the matrix factorizations were generated with
9 factors or topics.

### Topic model (fastTopics)

Here is the topic model with 9 topics:

```{r structure-plot-fasttopics, fig.height=2, fig.width=8, results="hide", message=FALSE}
celltype <- sample_info$celltype
celltype <-
 factor(celltype,
        c("acinar","ductal","activated_stellate","quiescent_stellate",
		  "endothelial","macrophage","mast","schwann","t_cell","alpha",
		  "beta","delta","gamma","epsilon"))
L <- poisson2multinom(pnmf)$L
structure_plot(L,grouping = celltype,gap = 20,perplexity = 70,n = Inf)
```

Most of the topics identify individual cell types or subsets of
similar cell types. The topics also identify some substructures within
and across cell types, e.g., topics 2 and 7. Most of the smaller cell
types are not captured as a separate topic.

### Flashier NMF

Let's now compare the topic model to the empirical Bayes NMF result
(with 9 factors).

I omit the first factor from the Structure plot because it is a
"baseline" factor, and therefore not interesting to look at:

```{r structure-plot-flashier-nmf, fig.height=2, fig.width=8, results="hide", message=FALSE}
L <- fl_nmf_ldf$L
k <- ncol(L)
colnames(L) <- paste0("k",1:k)
structure_plot(L[,-1],grouping = celltype,gap = 20,perplexity = 70,n = Inf) +
  labs(y = "membership",fill = "factor",color = "factor")
```

It is interesting that the EBNMF factors distinguish some of the rare
cell types, but do not distinguish as well among some of the islet
cells (e.g., delta and gamma), even though they are quite abundant.
It seems that these methods are each adept at identifying different
types of structure.

### NMF (NNLM)

Let's now have a look at the "vanilla" NMF (produced by the NNLM
package). As before, this NMF has 9 factors.

```{r structure-plot-nnlm, fig.height=2, fig.width=8, results="hide", message=FALSE}
scale_cols <- function (A, b)
  t(t(A) * b)
W <- nmf$W
k <- ncol(W)
d <- apply(W,2,max)
W <- scale_cols(W,1/d)
colnames(W) <- paste0("k",1:k)
structure_plot(W,grouping = celltype,gap = 20,perplexity = 70,n = Inf) +
  labs(y = "membership",fill = "factor",color = "factor")
```

Unlike the EBNMF results, there is no single factor that acts as a
"baseline". Some of the rarer cell types are missed by this NMF. It is
also interesting that it has identified a single factor (k = 4)
corresponding to all islet cells. Oddly, it seems to have identified
factors that are active in the same cells, such as factors 3 and 6, as
well as 7 and 8. So the NMF and EBNMF results are surprisingly
different.

### Flashier semi-NMF

The semi-NMF decomposition produced by flashier is interesting because
it identifies not only cell-type-specific factors (e.g., factors 6,
7, 9), but also factors capturing expression programs common to several
similar cell types (e.g., factors 2, 4, 8). 

```{r structure-plot-flashier-semi-nmf, fig.height=2, fig.width=8, results="hide", message=FALSE}
L <- fl_snmf_ldf$L
k <- ncol(L)
colnames(L) <- paste0("k",1:k)
structure_plot(L[,-c(1,5)],grouping = celltype,gap = 20,
               perplexity = 70,n = Inf)
```

In other words, the semi-NMF is capturing structure at different
levels of cell-type-specifity, achieving a cell-type "hierarchy" of
sorts. Note that I removed two factors (1 and 5) from the Structure
plot because they were active to varying degreees in all cells.

## Smart-seq2 data

[muraro-2016]: https://doi.org/10.1016/j.cels.2016.09.002
