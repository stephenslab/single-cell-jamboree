---
title: "Initial exploration of the human brain dataset: committed OPC cells"
author: Junming Guan
output: workflowr::wflow_html
---

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#", collapse = TRUE, results = "hold",
                      fig.align = "center", dpi = 120)
```

### Introduction

This single-nucleus RNA seq dataset is from the paper "Transcriptomic
diversity of cell types across the adult human brain"
([Siletti 2023][siletti-2023]). Around 3 millions nuclei were
collected from around 100 dissections from the following areas of
brains of 3 donors:

-   Forebrain:

    -   cerebral cortex

    -   cerebral nuclei

    -   hypothalamus

    -   hippocampus formation

    -   thalamus complex

-   Midbrain

-   Hindbrain:

    -   pons

    -   cerebellum

    -   Myelencephalon (Medulla)

-   Spinal cord

The authors performed hierarchical graph-based clustering, grouping
the cells into superclusters, clusters, and subclusters. The data can
be accessedÂ [here][hca-brain-data], with files organized by
supercluster or by dissection.

This exploratory analysis focuses on cells within the supercluster
called" committed oligodendrocyte precursor" (OPC), which consists of
non-neuron cells. There are 4,720 cells and 59,236 genes (31,720 genes
with at least one nonzero count) in the dataset.

```{r load-pkg, message=FALSE}
library(Matrix)
# library(MatrixExtra)
library(flashier)
library(fastTopics)
library(ggplot2)
library(cowplot)
library(dplyr)
```

```{r load-data, message=FALSE}
data <- readRDS("../data/human_brain_OPC_cells.rds")
counts <- t(data$RNA$data)
```


```{r custom-func}
map_tissue <- function(tissue) {
  if (tissue %in% c("cerebral cortex", "cerebral nuclei", "hypothalamus", 
                    "hippocampal formation", "thalamic complex")) {
    return("forebrain")
  } else if (tissue == "midbrain") {
    return("midbrain")
  } else if (tissue %in% c("pons", "cerebellum", "myelencephalon")) {
    return("hindbrain")
  } else if (tissue == "spinal cord") {
    return("spinal cord")
  } else {
    return(NA)
  }
}

regions <- sapply(data$tissue, map_tissue)

```

### t-SNE and UMAP

The dataset includes precomputed tSNE and UMAP embeddings, allowing us
to plot them directly. We can color the cells by tissue, by region, or
by cluster.

#### t-SNE

```{r tsne}
ggplot(Embeddings(data$tSNE) , aes(x = TSNE_1, y = TSNE_2, color = data$tissue)) +
  geom_point(alpha = 0.7) +
  labs(title = "t-SNE Plot Colored by Tissue Type", x = "t-SNE 1", y = "t-SNE 2") +
  theme_minimal() +
  scale_color_manual(values = rainbow(length(unique(data$tissue))))

ggplot(Embeddings(data$tSNE) , aes(x = TSNE_1, y = TSNE_2, color = regions)) +
  geom_point(alpha = 0.7) +
  labs(title = "t-SNE Plot Colored by Tissue Type", x = "t-SNE 1", y = "t-SNE 2") +
  theme_minimal() +
  scale_color_manual(values = rainbow(length(unique(regions))))

ggplot(Embeddings(data$tSNE) , aes(x = TSNE_1, y = TSNE_2, color = data$cluster_id)) +
  geom_point(alpha = 0.7) +
  labs(title = "t-SNE Plot Colored by Cluster", x = "t-SNE 1", y = "t-SNE 2") +
  theme_minimal() +
  scale_color_manual(values = rainbow(length(unique(data$cluster_id))))
```

```{r umap}
ggplot(Embeddings(data$UMAP) , aes(x = UMAP_1, y = UMAP_2, color = data$tissue)) +
  geom_point(alpha = 0.7) +
  labs(title = "UMAP Plot Colored by Tissue Type", x = "UMAP 1", y = "UMAP 2") +
  theme_minimal() +
  scale_color_manual(values = rainbow(length(unique(data$tissue))))

ggplot(Embeddings(data$UMAP) , aes(x = UMAP_1, y = UMAP_2, color = regions)) +
  geom_point(alpha = 0.7) +
  labs(title = "UMAP Plot Colored by Tissue Type", x = "UMAP 1", y = "UMAP 2") +
  theme_minimal() +
  scale_color_manual(values = rainbow(length(unique(regions))))

ggplot(Embeddings(data$UMAP) , aes(x = UMAP_1, y = UMAP_2, color = data$cluster_id)) +
  geom_point(alpha = 0.7) +
  labs(title = "UMAP Plot Colored by Cluster", x = "UMAP 1", y = "UMAP 2") +
  theme_minimal() +
  scale_color_manual(values = rainbow(length(unique(data$cluster_id))))
```

### Flashier

Before applying matrix factorization methods, we first remove genes
without nonzero counts.

```{r reduce-count}
cols_to_keep <- colSums(counts != 0, na.rm = TRUE) > 0
reduced_counts <- counts[, cols_to_keep]
```

```{r shifted-log-count}
n  <- nrow(reduced_counts)
x  <- rpois(1e7, 1/n)
s1 <- sd(log(x + 1))
a <- 1
size_factors <- rowSums(reduced_counts)
size_factors <- size_factors / mean(size_factors)
shifted_log_counts <- log1p(reduced_counts / (a * size_factors))
# shifted_log_counts <- mapSparse(reduced_counts / (a * size_factors), 
#                                 fn = log1p)
```

```{r fit-flashier}
flashier_fit <- flash(shifted_log_counts, 
             ebnm_fn = ebnm_point_exponential,
             var_type = 2, 
             greedy_Kmax = 7, 
             S = s1,
             backfit = F)
```

```{r flashier-struc-plot-cluster, message=FALSE, results='hide',fig.keep='all'}
plot(flashier_fit, 
     plot_type = "structure",
     pm_which = "loadings", 
     pm_groups = data$cluster_id, 
     gap = 25)

plot(flashier_fit, 
     plot_type = "structure",
     kset = 2:7,
     pm_which = "loadings", 
     pm_groups = data$cluster_id, 
     gap = 25)
```

```{r flashier-struc-plot-tissue, message=FALSE, results='hide',fig.keep='all'}
plot(flashier_fit, 
     plot_type = "structure",
     pm_which = "loadings", 
     pm_groups = data$tissue,
     gap = 25)

plot(flashier_fit, 
     plot_type = "structure",
     kset = 2:7,
     pm_which = "loadings", 
     pm_groups = data$tissue,
     gap = 25)
```

### Flashier: semi-nmf

```{r fit-flashier-seminmf}
flashier_fit_semi <- flash(shifted_log_counts, 
             ebnm_fn = c(ebnm_point_exponential, ebnm_point_laplace),
             var_type = 2, 
             greedy_Kmax = 7, 
             S = s1,
             backfit = F)
```

```{r flashier-seminmf-struc-plot, message=FALSE, results='hide',fig.keep='all'}
plot(flashier_fit_semi, 
     plot_type = "structure",
     pm_which = "loadings", 
     pm_groups = data$cluster_id,
     bins = 20, gap = 25)

plot(flashier_fit_semi, 
     plot_type = "structure",
     pm_which = "loadings", 
     pm_groups = data$tissue,
     bins = 20, gap = 25)
```

### FastTopics

```{r fit-fasttopics}
# reduced_counts <- as(reduced_counts, "dgCMatrix")
fasttopics_fit <- fit_topic_model(reduced_counts, k = 7)
```

```{r fasttopics-plot-progress, message=FALSE, results='hide',fig.keep='all'}
plot_progress(fasttopics_fit,x = "iter",add.point.every = 10,colors = "black") +
  theme_cowplot(font_size = 10)

```

```{r fasttopics-loglik-plot, message=FALSE, results='hide',fig.keep='all'}
loglik <- loglik_multinom_topic_model(reduced_counts, fasttopics_fit)
pdat <- data.frame(loglik)
ggplot(pdat,aes(loglik)) +
  geom_histogram(bins = 64,color = "white",fill = "black",size = 0.25) +
  labs(y = "number of cells") +
  theme_cowplot(font_size = 10)

# subpop_colors <- c("dodgerblue","forestgreen","darkmagenta","skyblue","gold", )
subpop_colors <- c("red", "blue", "green", "purple", "orange", "pink", "cyan", "brown", "yellow", "darkgreen")

pdat <- data.frame(loglik = loglik,subpop = data$tissue)
ggplot(pdat,aes(x = loglik,fill = subpop)) +
  geom_histogram(bins = 64,color = "white",size = 0.25) +
  scale_fill_manual(values = subpop_colors) +
  labs(y = "number of cells") +
  theme_cowplot(font_size = 10)
```

```{r fasttopics-struc-plot, message=FALSE, results='hide',fig.keep='all'}
structure_plot(fasttopics_fit, grouping = data$cluster_id, gap = 25)
structure_plot(fasttopics_fit, grouping = data$tissue, gap = 25)
```

### GBCD

TODO

```{r fit-gbcd}
# source("fit_cov_ebnmf.R")
# 
# fit.gbcd <-
#   flash_fit_cov_ebnmf(Y = reduced_counts, Kmax = 7,
#                       prior = flash_ebnm(prior_family = "generalized_binary",
#                                          scale = 0.04),
#                       extrapolate = FALSE)
```

[silleti-2023]: https://doi.org/10.1126/science.add7046
[hca-brain-data]: https://data.humancellatlas.org/hca-bio-networks/nervous-system/atlases/brain-v1-0
