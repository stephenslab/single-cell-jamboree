---
title: NMF analysis of the LPS data set
author: Peter Carbonetto
output: workflowr::wflow_html
---

Here we will revisit the LPS data set that we analyzed using a topic
model in the [Takahama et al Nat Immunol paper][takahama2024] (LPS =
lipopolysaccharide). I believe some interesting insights can be gained
by examining this data set more deeply.

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load packages used to process the data, perform the analyses, and
create the plots.

```{r load-pkgs, message=FALSE}
library(data.table)
library(fastTopics)
library(NNLM)
library(ebnm)
library(flashier)
library(singlecelljamboreeR)
library(ggplot2)
library(cowplot)
```

## Prepare the data for analysis with fastTopics and flashier

Load the RNA-seq counts:

```{r load-counts}
read_lps_data <- function (file) {
  counts <- fread(file)
  class(counts) <- "data.frame"
  genes <- counts[,1]
  counts <- t(as.matrix(counts[,-1]))
  colnames(counts) <- genes
  samples <- rownames(counts)
  samples <- strsplit(samples,"_")
  samples <- data.frame(tissue    = sapply(samples,"[[",1),
                        timepoint = sapply(samples,"[[",2),
                        mouse     = sapply(samples,"[[",3))
  samples <- transform(samples,
                       tissue    = factor(tissue),
					   timepoint = factor(timepoint),
					   mouse     = factor(mouse))
  return(list(samples = samples,counts = counts))
}
out <- read_lps_data("../data/lps.csv.gz")
samples <- out$samples
counts  <- out$counts
rm(out)
```

Remove a sample that appears to be an outlier based on the NMF analyses:

```{r filter-outliers}
i       <- which(rownames(counts) != "iLN_d2_20")
samples <- samples[i,]
counts  <- counts[i,]
```

Remove genes that are expressed in fewer than 5 samples:

```{r filter-genes}
j <- which(colSums(counts > 0) > 4)
counts <- counts[,j]
```

This is the dimension of the data set we will analyze:

```{r dim-counts}
dim(counts)
```

For the Gaussian-based analyses, we will need the shifted log counts:

```{r shifted-log-counts}
a <- 1
s <- rowSums(counts)
s <- s/mean(s)
shifted_log_counts <- log1p(counts/(a*s))
```

## Topic model (fastTopics)

First let's fit a topic model with $K = 9$ topics to the counts. This
is probably an insufficient number of topics to fully capture the
interesting structure in the data, but this is done on purpose since I
want to illustrate how the topic model prioritizes the structure.

```{r fit-topic-model-k9, cache=TRUE}
set.seed(1)
tm_k9 <- fit_poisson_nmf(counts,k = 9,init.method = "random",method = "em",
                         numiter = 20,verbose = "none",
		   			     control = list(numiter=4,nc=8,extrapolate=FALSE))
tm_k9 <- fit_poisson_nmf(counts,fit0 = tm_k9,method = "scd",numiter = 40,
                         control = list(numiter = 4,nc = 8,extrapolate = TRUE),
					     verbose = "none")
```

Structure plot comparing the topics to the tissue types:

```{r structure-plot-topic-model-k9, fig.height=1.5, fig.width=7}
rows <- order(samples$timepoint)
topic_colors <- c("magenta","darkorange","darkblue","forestgreen",
                  "dodgerblue","gray","red","olivedrab","darkmagenta",
                  "sienna","limegreen","royalblue","lightskyblue",
				  "gold")
samples <- transform(samples,
  tissue = factor(tissue,c("PBMC","BM","CO","SI","iLN","SP",
                           "TH","SK","BR","LI","HE","KI","LU")))
structure_plot(tm_k9,grouping = samples$tissue,gap = 4,
               topics = 1:9,colors = topic_colors,
   		       loadings_order = rows) +
  labs(fill = "") +
  theme(axis.text.x = element_text(angle = 0,hjust = 0.5))
```

Abbreviations used: BM = bone marrow; BR = brain; CO = colon; HE =
heart; iLN = inguinal lymph node; KI = kidney; LI = liver; LU = lung;
SI = small intestine; SK = skin; SP = spleen; TH = thymus.

The topics largely correspond to the different tissues, although
because there are more tissues than topics, some tissues that are more
similar to each other shared the same topic. It is also interesting
that, for the most part, none of the topics are capturing changes
downstream of the LPS treatment. So presumably these expression
changes are more subtle than the differences in expression among the
tissues.

Fit a topic model with $K = 14$ topics to the counts:

```{r fit-topic-model, cache=TRUE}
set.seed(1)
tm <- fit_poisson_nmf(counts,k = 14,init.method = "random",method = "em",
                      numiter = 20,verbose = "none",
					  control = list(numiter = 4,nc = 8,extrapolate = FALSE))
tm <- fit_poisson_nmf(counts,fit0 = tm,method = "scd",numiter = 40,
                      control = list(numiter = 4,nc = 8,extrapolate = TRUE),
					  verbose = "none")
```

Structure plot comparing the topics to the tissue types:

```{r structure-plot-topic-model, fig.height=1.5, fig.width=7}
structure_plot(tm,grouping = samples$tissue,gap = 4,
               topics = 1:14,colors = topic_colors,
   		       loadings_order = rows) +
  labs(fill = "") +
  theme(axis.text.x = element_text(angle = 0,hjust = 0.5),
        legend.key.height = unit(0.01,"cm"),
        legend.key.width = unit(0.2,"cm"),
        legend.text = element_text(size = 6))
```

This next structure plot better highlights the topics that are
capturing expression changes over time, some being presumably driven
by the LPS-induced sepsis:

```{r structure-plot-topic-model-2, fig.height=1.5, fig.width=7}
topic_colors <- c("magenta","gray50","gray65","gray40",
                  "gray85","gray75","red","gray80","gray90",
                  "gray60","limegreen","gray70","gray55",
				  "gold")
structure_plot(tm,grouping = samples$tissue,gap = 4,
               topics = 1:14,colors = topic_colors,
			   loadings_order = rows) +
  labs(fill = "") +
  theme(axis.text.x = element_text(angle = 0,hjust = 0.5),
        legend.key.height = unit(0.01,"cm"),
        legend.key.width = unit(0.2,"cm"),
        legend.text = element_text(size = 6))
```

TO DO: Examine more closely topics k1 and k7.

## EBNMF (flashier)

Similar to the topic modeling analysis, let's start by fitting an
EBNMF to the shifted log counts using flashier, first with $K = 9$.
Since the greedy initialization does not seem to work well in this
example, I'll use a different initialization strategy: obtain a "good"
initialization using the NNLM package, then use this initialization to
fit a NMF using flashier. This approach is implemented in the
following function:

```{r flashier-nmf-function}
flashier_nmf <- function (X, k = 3, n.threads = 1) {
  n <- nrow(X)
  m <- ncol(X)
  nmf0 <- nnmf(shifted_log_counts,k = 1,loss = "mse",method = "scd",
            max.iter = 10,verbose = 0,n.threads = n.threads)
  W0 <- nmf0$W
  H0 <- nmf0$H
  W0 <- cbind(W0,matrix(runif(n*(k-1)),n,k-1))
  H0 <- rbind(H0,matrix(runif(m*(k-1)),k-1,m))
  nmf <- nnmf(X,k,init = list(W = W0,H = H0),loss = "mse",method = "scd",
              max.iter = 10,verbose = 0,n.threads = n.threads)
  x  <- rpois(1e7,1/n)
  s1 <- sd(log(x + 1))
  out <- flash_init(X,var_type = 2,S = s1)
  out <- flash_factors_init(out,list(nmf$W,t(nmf$H)),ebnm_point_exponential)
  out <- flash_backfit(out,extrapolate = FALSE,maxiter = 100,verbose = 0)
  return(flash_backfit(out,extrapolate = TRUE,maxiter = 100,verbose = 0))
}
```

Now fit an NMF to the shifted log counts, with $K = 9$:

```{r flashier-nmf-k9, cache=TRUE}
set.seed(1)
fl_nmf_k9 <- flashier_nmf(shifted_log_counts,k = 9,n.threads = 8)
```

Structure plot comparing the topics to the tissue types:

```{r structure-plot-flashier-nmf-k9, fig.height=2, fig.width=7}
rows <- order(samples$timepoint)
topic_colors <- c("powderblue","dodgerblue","olivedrab","limegreen",
                  "forestgreen","red","darkmagenta","gray","darkorange",
                  "cyan","royalblue","darkblue","lightskyblue",
                  "gold","sienna")
L <- ldf(fl_nmf_k9,type = "i")$L
structure_plot(L,grouping = samples$tissue,gap = 4,
               topics = 1:9,colors = topic_colors,
			   loadings_order = rows) +
  labs(fill = "",y = "membership")
```

Like the topic model, the EBNMF model with $K = 9$ does not capture
any changes downstream of the LPS-induced sepsis.

Next fit an NMF to the shifted log counts using flashier, with $K =
15$:

```{r flashier-nmf-k15, cache=TRUE, warning=FALSE}
set.seed(1)
fl_nmf <- flashier_nmf(shifted_log_counts,k = 15,n.threads = 8)
```

Structure plot comparing the factors to the tissue types:

```{r structure-plot-flashier-nmf, fig.height=2, fig.width=7}
L <- ldf(fl_nmf,type = "i")$L
structure_plot(L,grouping = samples$tissue,gap = 4,
               topics = 1:15,colors = topic_colors,
			   loadings_order = rows) +
  labs(fill = "",y = "membership") +
  theme(axis.text.x = element_text(angle = 0,hjust = 0.5),
        legend.key.height = unit(0.01,"cm"),
        legend.key.width = unit(0.25,"cm"),
        legend.text = element_text(size = 7))
```

This next structure plot better highlights the topics that capture the
processes that are driven or may be driven by LPS-induced sepsis:

```{r structure-plot-flashier-nmf-2, fig.height=2, fig.width=7}
rows <- order(samples$timepoint)
topic_colors <- c("gray95","gray70","gray80","gray50",
                  "gray60","red","gray75","gray","gray85",
                  "gray90","gray65","darkblue","gray45",
                  "gray35","gray75")
L <- ldf(fl_nmf,type = "i")$L
structure_plot(L,grouping = samples$tissue,gap = 4,
                    topics = 1:15,colors = topic_colors,
					loadings_order = rows) +
  labs(fill = "",y = "membership") +
  theme(axis.text.x = element_text(angle = 0,hjust = 0.5),
        legend.key.height = unit(0.01,"cm"),
        legend.key.width = unit(0.25,"cm"),
        legend.text = element_text(size = 7))
```

TO DO NEXT: Look more closely at factor 6 in the EBNMF model and
topics 1 and 7 in the topic model. In particular, for topic 1, compute
"least extreme" LFCs; for topic 7, compute "vsnull" LFCs (to remove
effect of baseline). Then perform a GSEA on these LFCs, including the
LFCs from the EBNMF (simply obtained by extracting the F matrix from
the EBNMF fit).

[takahama2024]: https://doi.org/10.1038/s41590-023-01722-8


