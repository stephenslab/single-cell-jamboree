---
title: NMF analysis of the LPS data set
author: Peter Carbonetto
output: workflowr::wflow_html
---

Here we will revisit the LPS data set that we analyzed using a topic
model in the [Takahama et al Nat Immunol paper][takahama2024]. (LPS =
lipopolysaccharide).

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

Load packages used to process the data, perform the analyses, and
create the plots.

```{r load-pkgs, message=FALSE}
library(data.table)
library(fastTopics)
library(flashier)
library(singlecelljamboreeR)
library(ggplot2)
library(cowplot)
```

Set the seed for reproducibility:

```{r set-seed}
set.seed(1)
```

## Prepare the data for analysis with fastTopics and flashier

Load the RNA-seq counts:

```{r load-counts}
read_lps_data <- function (file) {
  counts <- fread(file)
  class(counts) <- "data.frame"
  genes <- counts[,1]
  counts <- t(as.matrix(counts[,-1]))
  colnames(counts) <- genes
  samples <- rownames(counts)
  samples <- strsplit(samples,"_")
  samples <- data.frame(tissue    = sapply(samples,"[[",1),
                        timepoint = sapply(samples,"[[",2),
                        mouse     = sapply(samples,"[[",3))
  samples <- transform(samples,
                       tissue    = factor(tissue),
					   timepoint = factor(timepoint),
					   mouse     = factor(mouse))
  return(list(samples = samples,counts = counts))
}
out <- read_lps_data("../data/lps.csv.gz")
samples <- out$samples
counts  <- out$counts
rm(out)
```

Remove genes that are expressed in fewer than 5 samples:

```{r}
j <- which(colSums(counts > 0) > 4)
counts <- counts[,j]
```

This is the dimension of the data set we will analyze:

```{r dim-counts}
dim(counts)
```

For the Gaussian-based analyses, we will need the shifted log counts:

```{r shifted-log-counts}
a <- 1
s <- rowSums(counts)
s <- s/mean(s)
shifted_log_counts <- log1p(counts/(a*s))
```

## Topic model (fastTopics)

Fit a topic model with $K = 17$ topics to the counts:

```{r fit-topic-model, cache=TRUE}
k <- 16
tm <- fit_poisson_nmf(counts,k = k,init.method = "random",method = "em",
                      numiter = 20,verbose = "none",
					  control = list(numiter = 4,nc = 8,extrapolate = FALSE))
tm <- fit_poisson_nmf(counts,fit0 = tm,method = "scd",numiter = 40,
                      control = list(numiter = 4,nc = 8,extrapolate = TRUE),
					  verbose = "none")
```

Structure plot comparing the topics to the organ types:

```{r structure-plot-topic-model, fig.height=1.5, fig.width=7}
rows <- order(samples$timepoint)
topic_colors <- c("darkblue","dodgerblue","darkorange","forestgreen",
                  "limegreen","tomato","darkred","olivedrab","magenta",
                  "darkmagenta","sienna","royalblue","lightskyblue",
                  "gold","red","cyan")
p <- structure_plot(tm,grouping = samples$tissue,gap = 4,
                    topics = 1:k,colors = topic_colors,
					loadings_order = rows) +
  labs(fill = "") +
  theme(axis.text.x = element_text(angle = 0,hjust = 0.5),
        legend.key.height = unit(0.01,"cm"),
        legend.key.width = unit(0.2,"cm"),
        legend.text = element_text(size = 6))
print(p)
```

Abbreviations used: BM = bone marrow; BR = brain; CO = colon; HE =
heart; iLN = inguinal lymph node; KI = kidney; LI = liver; LU = lung;
SI = small intestine; SK = skin; SP = spleen; TH = thymus.

```{r structure-plot-topic-model-2, fig.height=1.5, fig.width=7}
topics <- c(1,3,5,11,16)
p <- structure_plot(tm,grouping = samples$tissue,gap = 4,
                    topics = topics,colors = topic_colors,
					loadings_order = rows) +
  labs(fill = "") +
  theme(axis.text.x = element_text(angle = 0,hjust = 0.5),
        legend.key.height = unit(0.01,"cm"),
        legend.key.width = unit(0.2,"cm"),
        legend.text = element_text(size = 6))
print(p)
```

Perform DE analysis usingthe topic model:

```{r de-analysis, eval=FALSE}
de <- de_analysis(fit,counts,shrink.method = "ash",pseudocount = 0.1,
                  control = list(ns = 1000,nc = 8))
```

[takahama2024]: https://doi.org/10.1038/s41590-023-01722-8
