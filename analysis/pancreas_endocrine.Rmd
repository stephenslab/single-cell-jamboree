---
title: Initial exploration of the pancreas endocrine data set
author: Peter Carbonetto
output: workflowr::wflow_html
---

Downloaded GSE132188_adata.h5ad.h5 from
https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE132188

Ran prepare_pancreas_endocrine_data.py
to generate pancreas_endocrine_alldays.h5ad.

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

First, load the packages needed for this analysis. 

```{r load-pkgs, message=FALSE}
library(Matrix)
library(anndata)
library(reticulate)
library(tools)
Sys.getenv("RETICULATE_PYTHON")
```

**Note:** The AnnData Python package is needed to run this code. I
installed anndata 0.11.2 using conda.

Get the count data that was prepared using the Python script,
`prepare_pancreas_endocrine_data.py`.

```{r read-counts}
dat1   <- read_h5ad("../data/pancreas_endocrine_alldays.h5ad")
counts <- dat1$X
counts <- as(counts,"CsparseMatrix")
```

Get the meta-data downloaded from GEO.

```{r read-meta-data, message=FALSE}
dat2 <- read_h5ad("../data/GSE132188_adata.h5ad.h5")
```
Align the two data sets.

```{r align-data}
ids1   <- rownames(dat1$obs)
ids2   <- rownames(dat2$obs)
ids2   <- paste0("e",10*as.numeric(as.character(dat2$obs$day)),"-",ids2)
ids2   <- substr(ids2,1,23)
rows   <- which(is.element(ids1,ids2))
ids1   <- ids1[rows]
counts <- counts[rows,]
obs1   <- dat1$obs[rows,]
```

Check that the sample ids and genes are the same.

```{r check-data}
print(all(ids1 == ids2))
print(all(rownames(dat1$var) == rownames(dat2$var)))
```

Extract the gene info.

```{r get-gene-info}
gene_info <- dat2$var
gene_info <- cbind(gene = rownames(gene_info),gene_info)
rownames(gene_info) <- NULL
```

Extract the sample info.

```{r get-sample-info}
sample_info <- dat2$obs
umap <- dat2$obsm$X_umap
colnames(umap) <- c("umap1","umap2")
sample_info <- cbind(umap,sample_info)
```

Save the data and t-SNE results to an .Rdata file for more
convenient analysis in R:

```{r save-data, eval=FALSE}
save(list = c("gene_info","sample_info","counts"),
     file = "pancreas_endocrine.RData")
resaveRdaFiles("pancreas_endocrine.RData")
```
